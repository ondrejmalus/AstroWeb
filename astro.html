<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AstroWeb – Galerie</title>
  <link rel="icon" type="image/png" href="data/web_images/icon.png">
  
  <!-- CSS -->
  <link href="assets/css/style.css" rel="stylesheet">
  <link href="assets/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="assets/fonts/fontawesome/css/all.min.css">
</head>
<body class="body">

<main class="container mt-5 content">
  <h1 class="text-center mb-4" style="padding-top:80px">Astronomická galerie</h1>
  <p class="text-center mb-5 popisek">
    Prozkoumejte obrázky podle kategorií a podkategorií. Kliknutím na snímek se zobrazí detail a možnost lajkovat.
  </p>

  <div id="gallery"></div>
</main>

<!-- MODÁL -->
<div class="modal fade" id="imageModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Zavřít"></button>
      <div class="modal-body text-center">
        <img id="modalImage" src="" class="img-fluid rounded mb-3" alt="">
        <h5 class="modal-title" id="modalTitle"></h5>
        <p class="popis-main"><strong>Popis:</strong> <span id="modalDescription" class="modal-description"></span></p>
        <p><strong>Kategorie:</strong> <span id="modalType"></span></p>
        <p><strong>Souhvězdí:</strong> <span id="modalConstellation"></span></p>
        <p><strong>Vzdálenost (ly):</strong> <span id="modalDistance"></span></p>
        <p>
          <span id="likeBtn" class="like-btn">
            <i class="fas fa-thumbs-up"></i> <span id="likeCount">0</span>
          </span>
        </p>
        <div class="d-flex justify-content-between mt-3">
          <button id="prevBtn" class="btn btn-secondary">← Předchozí</button>
          <button id="nextBtn" class="btn btn-secondary">Další →</button>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="footer"></div>
<script src="layout/navbar.js"></script>
<script>
  fetch('/layout/footer.html')
    .then(res => res.text())
    .then(data => document.getElementById('footer').innerHTML = data);
</script>

<script>
let galleryData = [];
let currentIndex = 0;

// Funkce pro hezký formát textu
function formatTitle(str) {
  if (!str) return '';
  return str
    .replace(/_/g, ' ')             // podtržítka → mezery
    .split(' ')
    .map(w => w.charAt(0).toUpperCase() + w.slice(1)) // každé slovo s velkým písmenem
    .join(' ');
}

async function loadGallery() {
  const gallery = document.getElementById('gallery');

  try {
    const userId = localStorage.getItem('userId');
    const res = await fetch(`http://localhost:3000/gallery${userId ? '?userId=' + userId : ''}`);
    const data = await res.json();
    galleryData = data;

    gallery.innerHTML = '';

    // Kategorie podle toho, co je v DB
    const categories = [
      { key: 'sluneční_soustava', label: 'Sluneční soustava' },
      { key: 'hvězdy', label: 'Hvězdy' },
      { key: 'mlhoviny', label: 'Mlhoviny' },
      { key: 'hvězdokupy', label: 'Hvězdokupy' },
      { key: 'galaxie', label: 'Galaxie' }
    ];

    categories.forEach(cat => {
      const catItems = data.filter(item => item.category === cat.key);
      if (!catItems.length) return;

      const catDiv = document.createElement('div');
      catDiv.className = 'category mb-5';
      catDiv.innerHTML = `<h2>${cat.label}</h2>`;
      gallery.appendChild(catDiv);

      // Podkategorie
      const subcategories = [...new Set(catItems.map(i => i.subcategory))];
      subcategories.forEach(sub => {
        const subDiv = document.createElement('div');
        subDiv.className = 'subcategory mb-3';
        subDiv.innerHTML = `<h4 class="subcategory-header">${formatTitle(sub)}</h4>`; // hezký formát

        const row = document.createElement('div');
        row.className = 'subcategory-row d-flex overflow-auto';

        catItems.filter(i => i.subcategory === sub).forEach(item => {
          const card = document.createElement('div');
          card.className = 'card gallery-card shadow-sm me-3';
          card.style.minWidth = '400px';
          card.innerHTML = `
            <img src="/images/${item.image}" class="card-img-top" alt="${item.common_name}">
            <div class="card-body text-center">
              <h5 class="card-title">${item.common_name}</h5>
              <p class="card-text small">${item.name} | Souhvězdí: ${item.constellation}</p>
            </div>
          `;
          card.addEventListener('click', () => openModal(item));
          row.appendChild(card);
        });

        subDiv.appendChild(row);
        catDiv.appendChild(subDiv);
      });
    });

  } catch (err) {
    console.error('Chyba při načítání galerie:', err);
    gallery.innerHTML = '<p class="text-danger">Nepodařilo se načíst galerii.</p>';
  }
}

function openModal(item) {
  currentIndex = galleryData.findIndex(i => i.id === item.id);

  document.getElementById('modalImage').src = `/images/${item.image}`;
  document.getElementById('modalTitle').innerText = item.common_name;
  document.getElementById('modalDescription').innerText = item.fact || 'Žádný popis.';
  document.getElementById('modalType').innerText = formatTitle(item.category);
  document.getElementById('modalConstellation').innerText = item.constellation || '-';
  document.getElementById('modalDistance').innerText = item.distance || '-';
  document.getElementById('likeCount').innerText = item.likes || 0;

  const likeBtn = document.getElementById('likeBtn');
  if (item.likedByUser) {
    likeBtn.classList.add('liked');
  } else {
    likeBtn.classList.remove('liked');
  }

  const modalEl = document.getElementById('imageModal');
  let modalInstance = bootstrap.Modal.getInstance(modalEl);

  if (!modalInstance) {
    modalInstance = new bootstrap.Modal(modalEl);
  }

  modalInstance.show(); // ← vždy show()
}

// Přepínání
document.getElementById('prevBtn').addEventListener('click', () => {
  currentIndex = (currentIndex - 1 + galleryData.length) % galleryData.length;
  openModal(galleryData[currentIndex]);
});
document.getElementById('nextBtn').addEventListener('click', () => {
  currentIndex = (currentIndex + 1) % galleryData.length;
  openModal(galleryData[currentIndex]);
});

// Like tlačítko
document.getElementById('likeBtn').addEventListener('click', async () => {
  const item = galleryData[currentIndex];

  const userId = localStorage.getItem('userId');
  if (!userId) {
    alert('Pro lajkování se prosím přihlas.');
    return;
  }

  try {
    const res = await fetch(`http://localhost:3000/gallery/${item.id}/like`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ userId })
    });

    const data = await res.json();

    if (data.success) {
  item.likes = data.likes;
  item.likedByUser = true;
  document.getElementById('likeCount').innerText = data.likes;
  document.getElementById('likeBtn').classList.add('liked');
} else {
      alert(data.message || 'Chyba při lajkování.');
    }
  } catch (err) {
    console.error('Chyba při lajkování:', err);
    alert('Chyba serveru při lajkování.');
  }
});


document.addEventListener('DOMContentLoaded', loadGallery);

</script>


<!-- Scroll Top -->
<button onclick="scrollToTop()" id="scrollTopBtn" title="Zpět nahoru">
  <i class="fas fa-arrow-up"></i>
</button>
<script>
  window.onscroll = function () {
    const btn = document.getElementById("scrollTopBtn");
    btn.style.display = (document.documentElement.scrollTop > 500) ? "block" : "none";
  };
  function scrollToTop() { window.scrollTo({ top: 0, behavior: 'smooth' }); }
</script>

<script src="/assets/bootstrap/bootstrap.bundle.min.js"></script>
</body>
</html>
